.. _babs_merge_cli:

##############################################################
``babs merge``: Merge results and provenance
##############################################################

.. contents:: Table of Contents

**********************
Command-Line Arguments
**********************

.. argparse::
   :ref: babs.cli._parse_merge
   :prog: babs merge

**********************
Example commands
**********************

.. code-block:: bash

    babs merge /path/to/my_BABS_project

It's usually not necessary to add the other two arguments (``--chunk-size``, ``--trial-run``),
as those two arguments are mainly for developers to use.

**********************
Detailed description
**********************

``babs merge`` will generate a folder called ``merge_ds`` to perform merging.
This folder is also a DataLad dataset and a sibling of output RIA.

---------------------------------
What if ``babs merge`` fails?
---------------------------------

The folder ``merge_ds`` generated by ``babs merge`` won't be automatically removed
by ``babs merge``, as users may want to check files regarding warnings saved in this folder.
If you have fixed the issue based on the error message, and hope to rerun ``babs merge``,
you need to remove folder ``merge_ds`` first:

.. code-block:: bash

    # 1. go to `merge_ds` folder:
    cd /path/to/my_BABS_project/merge_ds

    # 2. save any new files:
    datalad save -m "save any untracked files generated by babs merge"

    # 3. ask DataLad not to track here:
    git annex dead here

    # 4. remove `merge_ds` DataLad dataset:
    cd ..
    datalad remove -d merge_ds --reckless availability

.. Developer's notes:
.. `datalad save` is just due to new files:
..  `merge_ds/code/log_git_annex_fsck.txt`   # will def appear
..  `merge_ds/code/list_content_missing.txt`   # extremely low chance to appear
..  `merge_ds/code/list_invalid_job_when_merging.txt`   #  very low chance to appear

.. After `git merge`, regardless of pushing to output RIA or not,
..  needs `--reckless availability`

-------------------------------------------
What if ``babs merge`` takes a long time?
-------------------------------------------

Usually ``babs merge`` won't take a long time. For example, merging FreeSurfer results (got from fMRIPrep)
for about n=2300 successful jobs took around 10-15 minutes.
However if you are concerned that ``babs merge`` takes a long time, you can:

* Either use `screen <https://www.gnu.org/software/screen/>`_
  so that even you are disconnected from the cluster login node, ``babs merge`` command keeps running;
* Or submit ``babs merge`` as a job.

**********************
See also
**********************
:doc:`after_jobs`
