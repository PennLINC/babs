#!{{ interpreting_shell }}
{% for scheduler_directive in scheduler_directives %}
{{ scheduler_directive }}
{% endfor %}

{{ script_preamble }}

# Fail whenever something is fishy, use -x to get verbose logfiles:
set -e -u -x

# Inputs of the bash script:
dssource="$1"	# i.e., `input_ria`
pushgitremote="$2"	# i.e., `output_ria`
SUBJECT_CSV="$3"

subject_row=$(head -n $((${SLURM_ARRAY_TASK_ID} + 1)) ${SUBJECT_CSV} | tail -n 1)
subid=$(echo "$subject_row" | python -c "import sys, re; pattern = r'sub-[a-zA-Z0-9]+(?=,|$)'; matches = re.findall(pattern, sys.stdin.read()); print(matches[0] if len(matches) == 1 else 'ERROR')")
sesid=$(echo "$subject_row" | python -c "import sys, re; pattern = r'ses-[a-zA-Z0-9]+(?=,|$)'; matches = re.findall(pattern, sys.stdin.read()); print(matches[0] if len(matches) == 1 else 'ERROR')")

# Change to a temporary directory
cd "{{ job_scratch_directory }}"

# Setup: ---------------------------------------------------------------
# set up the branch:
echo '# Branch name (also used as temporary directory):'
{% if system.type == 'sge' %}
varname_jobid='JOB_ID'
{% elif system.type == 'slurm' %}
varname_jobid='SLURM_ARRAY_JOB_ID'
{% endif %}

{% if processing_level == 'session' %}
BRANCH="job-${varname_jobid}-${subid}-${sesid}"
{% else %}
BRANCH="job-${varname_jobid}-${subid}"
{% endif %}

mkdir "${BRANCH}"
cd "${BRANCH}"

# datalad clone the input ria:
echo '# Clone the data from input RIA:'
datalad clone "${dssource}" ds
cd ds

# set up the result deposition:
echo '# Register output RIA as remote for result deposition:'
git remote add outputstore "${pushgitremote}"

# set up a new branch:
echo "# Create a new branch for this job's results:"
git checkout -b "${BRANCH}"

# Start of the application-specific code: ------------------------------

# pull down input data (but don't retrieve the data content) and remove other sub's data:
echo "# Pull down the input subject (or dataset) but don't retrieve data contents:"
{% for input_dataset in input_datasets %}
{% if not input_dataset['is_zipped'] %}
datalad get -n "{{ input_dataset['path_now_rel'] }}/${subid}"
(cd {{ input_dataset['path_now_rel'] }} && find . -type d -name 'sub*' | grep -v $subid | xargs rm -rf)
{% else %}
datalad get -n "{{ input_dataset['path_now_rel'] }}"
(cd {{ input_dataset['path_now_rel'] }} && find . -type f -name 'sub*.zip' | grep -v $subid | xargs rm -f)
{% endif %}
{% endfor %}

{{ zip_locator_text }}

# datalad run:
datalad run \
	-i "code/{{ container_name }}_zip.sh" \
{% for input_dataset in input_datasets %}
{% if not input_dataset['is_zipped'] %}
	-i "{{ input_dataset['path'] }}/{% if processing_level == 'session' %}${subid}/${sesid}{% else %}${subid}{% endif %}" \
	-i "{{ input_dataset['path'] }}/*json" \
{% else %}
	-i "${%raw%}{{%endraw%}{{ input_dataset['name'] }}_ZIP{%raw%}}{%endraw%}" \
{% endif %}
{% endfor %}
	-i "containers/.datalad/environments/{{container_name}}/image" \
{% if flag_expand_inputs %}
	--expand inputs \
{% endif %}
	--explicit \
{% for key, value in container.config['zip_foldernames'].items() %}
	-o "${subid}{% if processing_level == 'session' %}_${sesid}{% endif %}_{{ key }}-{{ value }}.zip" \
{% endfor %}
	-m "{{ container_name }} ${subid}{% if processing_level == 'session' %} ${sesid}{% endif %}" \
	"bash ./code/{{ container_name }}_zip.sh ${subid} {% if processing_level == 'session' %} ${sesid}{% endif %}{% for input_dataset in input_datasets %}{% if input_dataset['is_zipped'] %}${%raw%}{{%endraw%}{{ input_dataset['name'].upper() }}_ZIP}{%raw%}}{%endraw%}{%endif%}{%endfor%}"

# Finish up:
# push result file content to output RIA storage:
echo '# Push result file content to output RIA storage:'
datalad push --to output-storage

# push the output branch:
echo '# Push the branch with provenance records:'
flock "${DSLOCKFILE}" git push outputstore

# Delete:
echo "echo 'Delete temporary directory:'"
echo "${BRANCH}"
{% for dataset in input_datasets %}
datalad drop -d {{ dataset.path }} -r --reckless availability --reckless modification
{% endfor %}

datalad drop -r . --reckless availability --reckless modification

git annex dead here

# cd out of $BRANCH:
cd ../..
rm -rf "${BRANCH}"

echo SUCCESS