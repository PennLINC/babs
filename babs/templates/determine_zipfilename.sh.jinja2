{% if any(input_dataset['is_zipped'] for input_dataset in input_datasets) %}
find_single_zipfile() {% raw %}{{% endraw %}
    local path="$1"
    local name="$2"
    local pattern="${path}/${subid}_${sesid:+${sesid}_}*${name}*.zip"
    local zipfile
    zipfile=$(ls $pattern | cut -d '@' -f 1 || true)

    if [ -z "$zipfile" ]; then
        echo "No zip file found matching pattern: $pattern" >&2
        exit 99
    fi

    # Convert to array to check count
    local files=($zipfile)
    if [ "${% raw %}{{% endraw %}#files[@]{% raw %}}{% endraw %}" -gt "1" ]; then
        echo "Multiple zip files found matching pattern: $pattern" >&2
        exit 98
    fi

    echo "$zipfile"
{% raw %}}{% endraw %}

{% for input_dataset in input_datasets %}
{% if input_dataset['is_zipped'] %}
{{ input_dataset['name'].upper() }}_ZIP="$(find_single_zipfile {{ input_dataset['path_now_rel'] }} {{ input_dataset['name'] }})"
echo 'found {{ input_dataset['name'] }} zipfile:'
echo "${{{ input_dataset['name'].upper() }}}_ZIP"
{% endif %}
{% endfor %}
{% endif %}
